<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة التحكم — مُحسَّنة</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f1724; --card:rgba(255,255,255,0.03); --muted:#94a3b8; --text:#e6eef8; --brand:#0ea5e9;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{ background:var(--bg); color:var(--text); font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; margin:0; }
  .app{ display:grid; grid-template-columns:260px 1fr; min-height:100vh; gap:0; }
  .sidebar{ background:linear-gradient(180deg, rgba(14,165,233,.12), transparent 30%), #071022; border-inline-end:1px solid rgba(255,255,255,.04); padding-bottom:16px; }
  .sidebar .brand{ display:flex; align-items:center; gap:10px; padding:18px; border-bottom:1px solid rgba(255,255,255,.04)}
  .brand .logo{ width:44px; height:44px; border-radius:10px; background:var(--brand); display:grid; place-items:center; color:#042033; font-weight:800; font-size:18px; box-shadow:0 4px 14px rgba(14,165,233,.08); }
  .nav-link{ color:#dbeafe; border-radius:10px; padding:.65rem .9rem; display:flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none; }
  .nav-link:hover{ background:rgba(14,165,233,.08); color:#fff; transform: translateX(-3px); transition:all .12s ease; }
  .nav-link.active{ background:linear-gradient(90deg, rgba(14,165,233,.14), rgba(14,165,233,.06)); color:#fff; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02); }
  .content{ display:grid; grid-template-rows:auto 1fr; min-height:100vh; }
  .topbar{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.04); background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
  .card{ background:var(--card); border:none; border-radius:12px; box-shadow: 0 6px 18px rgba(2,6,23,.4); }
  .section-title{ color:#dbeafe; font-weight:700; }
  .muted{ color:var(--muted); }
  .img-thumb{ width:100%; height:180px; object-fit:cover; border-radius:10px; }
  .badge-soft{ background:rgba(255,255,255,.04); color:#e6eef8; border:1px solid rgba(255,255,255,.03) }
  .btn-brand{ background:var(--brand); color:#042033; border: none; font-weight:600; }
  .btn-brand:hover{ background:#0898d0; color:#fff; }
  .table-dark{ --bs-table-bg:transparent; --bs-table-striped-bg:rgba(255,255,255,.03); --bs-table-striped-color:#fff; color:#e6eef8; }
  .grid{ display:grid; gap:1rem; }
  .grid-3{ grid-template-columns:repeat(3,1fr) }
  .grid-2{ grid-template-columns:repeat(2,1fr) }
  .small-alert{ transition: all .25s ease; }
  .fade-in{ animation: fadeIn .28s ease both; }
  @keyframes fadeIn { from{ opacity:0; transform: translateY(6px) } to{ opacity:1; transform: translateY(0) } }
  @media(max-width:992px){
    .app{ grid-template-columns:1fr }
    .sidebar{ position:fixed; z-index:1000; inset:0 auto 0 0; transform:translateX(100%); width:82%; transition:.25s; overflow:auto; }
    .sidebar.open{ transform:translateX(0) }
    .content{ margin-inline-start:0 }
  }
  /* toast box */
  #toastBox{ position:fixed; z-index:2000; left:20px; top:20px; display:flex; flex-direction:column; gap:8px; }
  .toast-item{ min-width:220px; max-width:380px; padding:10px 12px; border-radius:10px; color:#042033; font-weight:600; box-shadow:0 8px 30px rgba(2,6,23,.5); }
  .toast-success{ background: #b7f0ff; }
  .toast-error{ background:#ffd1d1; }
  .toast-info{ background:#e7f8ff; }
  /* subtle input focus */
  input:focus, textarea:focus, select:focus { outline: none; box-shadow: 0 6px 20px rgba(14,165,233,.06); border-color: rgba(14,165,233,.2); }
</style>
</head>
<body>

<div id="toastBox"></div>

<div class="app">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="brand">
      <div class="logo" id="brandLogo">A</div>
      <div>
        <div class="fw-bold">لوحة التحكم</div>
        <div class="small muted" id="apiBaseShow">API: …</div>
      </div>
    </div>

    <nav class="p-3 d-grid gap-2" id="navList">
      <div class="nav-link active" data-target="home"><i class="fa-solid fa-house"></i> الصفحة الرئيسية</div>
      <div class="nav-link" data-target="projects"><i class="fa-solid fa-folder-tree"></i> المشاريع</div>
      <div class="nav-link" data-target="posts"><i class="fa-solid fa-images"></i> المنشورات</div>
      <div class="nav-link" data-target="appointments"><i class="fa-solid fa-calendar-check"></i> المواعيد</div>
      <div class="nav-link" data-target="technologies"><i class="fa-solid fa-microchip"></i> التقنيات</div>
      <div class="nav-link" data-target="testimonials"><i class="fa-solid fa-comment-dots"></i> آراء العملاء</div>
      <div class="nav-link" data-target="users"><i class="fa-solid fa-user-group"></i> المستخدمون</div>
      <div class="nav-link" data-target="settings"><i class="fa-solid fa-gear"></i> الإعدادات</div>
    </nav>

    <div class="px-3 pb-3">
      <div class="card p-3 mt-3">
        <div class="small muted mb-2">شركاء</div>
        <div class="d-flex flex-wrap gap-2" id="partners">
          <img src="https://dummyimage.com/60x28/0ea5e9/ffffff.png&text=P1" class="rounded" alt="">
          <img src="https://dummyimage.com/60x28/64748b/ffffff.png&text=P2" class="rounded" alt="">
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-light d-lg-none" id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
        <span class="muted">مرحباً، <span id="whoami">زائر</span></span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-light btn-sm" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i> دخول</button>
        <button class="btn btn-outline-light btn-sm" id="btnLogout" style="display:none"><i class="fa-solid fa-arrow-right-from-bracket"></i> خروج</button>
      </div>
    </div>

    <!-- Views container -->
    <div class="p-3 p-lg-4">

      <!-- HOME -->
      <section id="view-home" class="d-block fade-in">
        <h3 class="section-title mb-3">الصفحة الرئيسية</h3>
        <div class="grid grid-3 mb-3">
          <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="muted small">المشاريع</div>
                <div class="fs-3 fw-bold" id="statProjects">0</div>
              </div>
              <i class="fa-solid fa-folder-open fa-2x text-info"></i>
            </div>
          </div>
          <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="muted small">المنشورات</div>
                <div class="fs-3 fw-bold" id="statPosts">0</div>
              </div>
              <i class="fa-solid fa-image fa-2x text-warning"></i>
            </div>
          </div>
          <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="muted small">المواعيد</div>
                <div class="fs-3 fw-bold" id="statAppointments">0</div>
              </div>
              <i class="fa-solid fa-calendar-check fa-2x text-success"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">نظرة عامة</h5>
              <button class="btn btn-sm btn-outline-light" id="refreshHome"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <canvas id="homeChart" height="100"></canvas>
          </div>
          <div class="card p-3">
            <h5 class="mb-3">أحدث المواعيد</h5>
            <div class="table-responsive" style="max-height:280px">
              <table class="table table-dark table-striped align-middle small mb-0">
                <thead><tr><th>الاسم</th><th>البريد</th><th>التاريخ</th><th>الملف</th></tr></thead>
                <tbody id="homeLastAppointments"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PROJECTS -->
      <section id="view-projects" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">المشاريع</h3>
          <div class="d-flex gap-2">
            <input id="projSearch" class="form-control form-control-sm" placeholder="بحث بالاسم أو التقنية">
            <select id="projFilter" class="form-select form-select-sm">
              <option value="all">كل الأنواع</option>
              <option value="web">Web</option><option value="flutter">Flutter</option><option value="design">Design</option>
            </select>
            <button class="btn btn-brand btn-sm" id="openProjectForm"><i class="fa-solid fa-plus"></i> إضافة</button>
            <button class="btn btn-outline-light btn-sm" id="reloadProjects"><i class="fa-solid fa-rotate"></i></button>
          </div>
        </div>

        <div class="row g-3" id="projectsGrid"></div>

        <div class="card p-3 mt-3" id="projectEditorCard" style="display:none">
          <h5 class="mb-2">إضافة / تعديل مشروع</h5>
          <form id="projectForm" enctype="multipart/form-data">
            <input type="hidden" name="id" id="p_id">
            <div class="row g-2">
              <div class="col-md-4"><input class="form-control form-control-sm" name="Name" id="p_name" placeholder="الاسم" required></div>
              <div class="col-md-8"><input class="form-control form-control-sm" name="ProjectLink" id="p_link" placeholder="رابط المشروع (اختياري)"></div>
              <div class="col-12"><textarea class="form-control form-control-sm" name="Description" id="p_desc" rows="2" placeholder="الوصف" required></textarea></div>
              <div class="col-md-3">
                <select class="form-select form-select-sm" name="ProjectType" id="p_type">
                  <option value="web">Web</option><option value="flutter">Flutter</option><option value="design">Design</option>
                </select>
              </div>
              <div class="col-md-5">
                <input class="form-control form-control-sm" id="p_techInput" placeholder="أضف تقنية واضغط إضافة">
                <div class="small muted mt-1">التقنيات: <span id="p_techTags"></span></div>
              </div>
              <div class="col-md-2"><button type="button" id="p_addTech" class="btn btn-outline-info btn-sm w-100">إضافة تقنية</button></div>
              <div class="col-md-2"><input class="form-control form-control-sm" type="file" id="p_image" accept="image/*"></div>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-brand btn-sm" type="submit" id="p_saveBtn"><i class="fa-solid fa-floppy-disk"></i> حفظ</button>
              <button class="btn btn-secondary btn-sm" type="button" id="p_reset">تفريغ</button>
              <button class="btn btn-outline-light btn-sm ms-auto" type="button" id="closeProjectEditor">إغلاق</button>
            </div>
            <div id="p_alert" class="mt-2 small small-alert"></div>
          </form>
        </div>
      </section>

      <!-- POSTS -->
      <section id="view-posts" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">المنشورات</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-brand btn-sm" id="openPostForm"><i class="fa-solid fa-plus"></i> منشور جديد</button>
            <button class="btn btn-outline-light btn-sm" id="reloadPosts"><i class="fa-solid fa-rotate"></i></button>
          </div>
        </div>

        <div class="row g-3" id="postsGrid"></div>

        <div class="card p-3 mt-3" id="postEditorCard" style="display:none">
          <h5 class="mb-2">إضافة منشور</h5>
          <form id="postForm" enctype="multipart/form-data">
            <div class="row g-2">
              <div class="col-md-8"><input class="form-control form-control-sm" name="Text" id="post_text" placeholder="نص المنشور" required></div>
              <div class="col-md-4"><input class="form-control form-control-sm" type="file" id="post_photos" multiple accept="image/*"></div>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-brand btn-sm" type="submit"><i class="fa-solid fa-paper-plane"></i> نشر</button>
              <button class="btn btn-secondary btn-sm" type="button" id="post_reset">تفريغ</button>
              <button class="btn btn-outline-light btn-sm ms-auto" type="button" id="closePostEditor">إغلاق</button>
            </div>
            <div id="post_alert" class="mt-2 small small-alert"></div>
          </form>
        </div>
      </section>

      <!-- APPOINTMENTS -->
      <section id="view-appointments" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">المواعيد</h3>
          <button class="btn btn-outline-light btn-sm" id="reloadAppointments"><i class="fa-solid fa-rotate"></i></button>
        </div>
        <div class="grid grid-2 mb-3">
          <div class="card p-3">
            <h6 class="mb-2">نموذج إضافة موعد</h6>
            <form id="appointmentForm" enctype="multipart/form-data">
              <div class="row g-2">
                <div class="col-md-6"><input class="form-control form-control-sm" name="FullName" placeholder="الاسم الكامل" required></div>
                <div class="col-md-6"><input class="form-control form-control-sm" name="Email" placeholder="البريد"></div>
                <div class="col-md-6"><input class="form-control form-control-sm" name="Phone" placeholder="الهاتف"></div>
                <div class="col-md-3"><input class="form-control form-control-sm" name="Date" type="date" placeholder="تاريخ"></div>
                <div class="col-md-3"><input class="form-control form-control-sm" name="Time" type="time" placeholder="وقت"></div>
                <div class="col-12"><textarea class="form-control form-control-sm" name="Description" rows="2" placeholder="الوصف"></textarea></div>
                <div class="col-md-6"><input class="form-control form-control-sm" type="file" name="file"></div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-brand btn-sm" type="submit">حفظ</button>
                <button class="btn btn-secondary btn-sm" type="reset">تفريغ</button>
              </div>
              <div id="appt_alert" class="mt-2 small small-alert"></div>
            </form>
          </div>
          <div class="card p-3">
            <h6 class="mb-2">جميع المواعيد</h6>
            <div class="table-responsive" style="max-height:420px">
              <table class="table table-dark table-striped align-middle small">
                <thead><tr><th>#</th><th>الاسم</th><th>البريد</th><th>الهاتف</th><th>التاريخ</th><th>وقت</th><th>ملف</th></tr></thead>
                <tbody id="appointmentsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- TECHNOLOGIES -->
      <section id="view-technologies" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">التقنيات</h3>
          <button class="btn btn-outline-light btn-sm" id="reloadTech"><i class="fa-solid fa-rotate"></i></button>
        </div>
        <div class="row g-3" id="techGrid"></div>

        <div class="card p-3 mt-3" id="techEditorCard" style="display:none">
          <h5 class="mb-2">إضافة / تعديل تقنية</h5>
          <form id="techForm" enctype="multipart/form-data">
            <input type="hidden" id="t_id">
            <div class="row g-2">
              <div class="col-md-6"><input class="form-control form-control-sm" id="t_name" name="TechnologyName" placeholder="اسم التقنية" required></div>
              <div class="col-md-6"><input class="form-control form-control-sm" type="file" id="t_image" name="Image" accept="image/*"></div>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-brand btn-sm" type="submit">حفظ</button>
              <button class="btn btn-secondary btn-sm" type="button" id="t_reset">تفريغ</button>
              <button class="btn btn-outline-light btn-sm ms-auto" type="button" id="closeTechEditor">إغلاق</button>
            </div>
            <div id="t_alert" class="mt-2 small small-alert"></div>
          </form>
        </div>
      </section>

      <!-- TESTIMONIALS -->
      <section id="view-testimonials" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">آراء العملاء</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-brand btn-sm" id="openTestimonialForm"><i class="fa-solid fa-plus"></i> إضافة رأي</button>
            <button class="btn btn-outline-light btn-sm" id="reloadTestimonials"><i class="fa-solid fa-rotate"></i></button>
          </div>
        </div>

        <div class="row g-3" id="testimonialGrid"></div>

        <div class="card p-3 mt-3" id="testimonialEditorCard" style="display:none">
          <h5 class="mb-2">إضافة / تعديل رأي</h5>
          <form id="testimonialForm" enctype="multipart/form-data">
            <input type="hidden" id="tt_id">
            <div class="row g-2">
              <div class="col-md-6"><input class="form-control form-control-sm" id="tt_name" name="Name" placeholder="الاسم" required></div>
              <div class="col-md-6"><input class="form-control form-control-sm" id="tt_job" name="JobOrCompany" placeholder="الوظيفة/الشركة"></div>
              <div class="col-12"><textarea class="form-control form-control-sm" id="tt_opinion" name="Opinion" rows="2" placeholder="الرأي" required></textarea></div>
              <div class="col-md-6"><input class="form-control form-control-sm" type="file" id="tt_image" name="Image" accept="image/*"></div>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-brand btn-sm" type="submit">حفظ</button>
              <button class="btn btn-secondary btn-sm" type="button" id="tt_reset">تفريغ</button>
              <button class="btn btn-outline-light btn-sm ms-auto" type="button" id="closeTestimonialEditor">إغلاق</button>
            </div>
            <div id="tt_alert" class="mt-2 small small-alert"></div>
          </form>
        </div>
      </section>

      <!-- USERS -->
      <section id="view-users" class="d-none">
        <h3 class="section-title mb-2">المستخدمون</h3>
        <div class="alert alert-info">
          لا يوجد Endpoint لعرض/إدارة المستخدمين في السيرفر الحالي. المتاح فقط <code>POST /api/auth/login</code>.
        </div>
        <div class="card p-3">
          <h6 class="mb-2">تجربة تسجيل الدخول</h6>
          <form id="loginForm" class="row g-2">
            <div class="col-md-4"><input class="form-control form-control-sm" name="username" placeholder="اسم المستخدم" required value="admin"></div>
            <div class="col-md-4"><input class="form-control form-control-sm" name="password" placeholder="كلمة المرور" required value="1234" type="password"></div>
            <div class="col-md-4"><button class="btn btn-brand btn-sm w-100" type="submit">تسجيل الدخول</button></div>
          </form>
          <div id="login_alert" class="mt-2 small"></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="d-none">
        <h3 class="section-title mb-3">الإعدادات</h3>
        <div class="grid grid-2">
          <div class="card p-3">
            <h6 class="mb-2">إعدادات النظام</h6>
            <form id="settingsForm" class="row g-2">
              <div class="col-12">
                <label class="form-label small">رابط الـ API</label>
                <input class="form-control form-control-sm" id="set_api" placeholder="http://localhost:3000">
              </div>
              <div class="col-6">
                <label class="form-label small">اختصار الشعار</label>
                <input class="form-control form-control-sm" id="set_logoText" maxlength="2" placeholder="A">
              </div>
              <div class="col-6">
                <label class="form-label small">الثيم</label>
                <select class="form-select form-select-sm" id="set_theme">
                  <option value="dark">داكن</option>
                  <option value="light">فاتح</option>
                </select>
              </div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-brand btn-sm" type="submit">حفظ</button>
                <button class="btn btn-secondary btn-sm" type="button" id="settingsReset">افتراضي</button>
              </div>
              <div id="settings_alert" class="mt-2 small"></div>
            </form>
          </div>
          <div class="card p-3">
            <h6 class="mb-2">شركاء (عرض جانبي)</h6>
            <div class="d-flex gap-2 mb-2">
              <input class="form-control form-control-sm" id="partner_add" placeholder="رابط صورة الشريك">
              <button class="btn btn-outline-light btn-sm" id="partner_add_btn">إضافة</button>
            </div>
            <div id="partner_list" class="d-flex flex-wrap gap-2"></div>
            <div class="small muted mt-2">تُحفظ محلياً في المتصفح.</div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Scripts -->
<script>
/* ======= إعدادات وتهيئة API ======= */
const defaults = {
  API_BASE: localStorage.getItem('API_BASE') || 'http://localhost:3000',
  theme: localStorage.getItem('theme') || 'dark',
  logoText: localStorage.getItem('logoText') || 'A',
  partners: JSON.parse(localStorage.getItem('partners')||'[]'),
};
let API_BASE = defaults.API_BASE;
function buildAPI() {
  return {
    appointment: API_BASE + '/api/Appointment',
    post: API_BASE + '/api/Post',
    project: API_BASE + '/api/Project',
    tech: API_BASE + '/api/Technology',
    testimonial: API_BASE + '/api/Testimonial',
    login: API_BASE + '/api/auth/login'
  };
}
let API = buildAPI();

document.getElementById('apiBaseShow').textContent = 'API: ' + API_BASE;
document.getElementById('brandLogo').textContent = defaults.logoText;

/* ======= Toast helper ======= */
const toastBox = document.getElementById('toastBox');
function pushToast(text, type='info', timeout=3000){
  const div = document.createElement('div');
  div.className = 'toast-item toast-'+(type==='success'?'success':type==='error'?'error':'info');
  div.textContent = text;
  toastBox.appendChild(div);
  setTimeout(()=> div.style.opacity = '0', timeout-500);
  setTimeout(()=> div.remove(), timeout);
}

/* ======= URL helper for uploaded files ======= */
function urlFor(p){
  if(!p) return '';
  if(p.startsWith('http://') || p.startsWith('https://')) return p;
  const base = API_BASE.replace(/\/+$/,'');
  const path = p.replace(/^\/+/,'');
  return base + '/' + path;
}

/* ======= sidebar & navigation ======= */
const sidebar = document.getElementById('sidebar');
document.getElementById('toggleSidebar').onclick = ()=> sidebar.classList.toggle('open');
const navLinks = Array.from(document.querySelectorAll('.nav-link'));
const views = {
  home: document.getElementById('view-home'),
  projects: document.getElementById('view-projects'),
  posts: document.getElementById('view-posts'),
  appointments: document.getElementById('view-appointments'),
  technologies: document.getElementById('view-technologies'),
  testimonials: document.getElementById('view-testimonials'),
  users: document.getElementById('view-users'),
  settings: document.getElementById('view-settings'),
};
navLinks.forEach(link=>{
  link.addEventListener('click', ()=>{
    navLinks.forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    const target = link.dataset.target;
    Object.values(views).forEach(v=>v.classList.add('d-none'));
    if(views[target]) views[target].classList.remove('d-none');
    if(window.innerWidth < 992) sidebar.classList.remove('open');
  });
});

/* ======= Stats (home) ======= */
let chart = null;
async function loadStats(){
  API = buildAPI();
  document.getElementById('apiBaseShow').textContent = 'API: ' + API_BASE;
  try{
    const [projectsRes, postsRes, apptsRes] = await Promise.all([
      fetch(API.project).catch(()=>({ok:false})),
      fetch(API.post).catch(()=>({ok:false})),
      fetch(API.appointment).catch(()=>({ok:false}))
    ]);
    const projects = projectsRes.ok ? await projectsRes.json() : [];
    const posts = postsRes.ok ? await postsRes.json() : [];
    const appts = apptsRes.ok ? await apptsRes.json() : [];

    document.getElementById('statProjects').textContent = (projects||[]).length;
    document.getElementById('statPosts').textContent = (posts||[]).length;
    document.getElementById('statAppointments').textContent = (appts||[]).length;

    // last appointments
    const tb = document.getElementById('homeLastAppointments');
    tb.innerHTML = '';
    (appts||[]).slice(-6).reverse().forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.FullName||'-'}</td><td>${a.Email||'-'}</td><td>${a.Date||'-'}</td><td>${a.file?`<a href="${urlFor(a.file)}" target="_blank">تحميل</a>`:'-'}</td>`;
      tb.appendChild(tr);
    });

    // chart
    const labels = ['مشاريع','منشورات','مواعيد'];
    const data = [ (projects||[]).length, (posts||[]).length, (appts||[]).length ];
    const ctx = document.getElementById('homeChart');
    if(chart){ chart.destroy(); chart = null; }
    chart = new Chart(ctx, { type: 'bar', data: { labels, datasets:[{ label:'إجمالي العناصر', data }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });

  }catch(err){ console.warn(err); pushToast('تعذر جلب الإحصاءات', 'error'); }
}
document.getElementById('refreshHome').onclick = loadStats;

/* ======= Projects (FIX: edit now uses GET all then find by id) ======= */
let projTags = [];
const tagWrap = document.getElementById('p_techTags');
function renderProjTags(){ tagWrap.innerHTML = projTags.map(t=>`<span class="badge rounded-pill text-bg-info me-1">${t}</span>`).join(' '); }

document.getElementById('p_addTech').onclick = ()=>{
  const v = document.getElementById('p_techInput').value.trim();
  if(v && !projTags.includes(v)){ projTags.push(v); renderProjTags(); }
  document.getElementById('p_techInput').value = '';
};
document.getElementById('p_reset').onclick = ()=>{ document.getElementById('projectForm').reset(); projTags=[]; renderProjTags(); document.getElementById('p_id').value=''; };
document.getElementById('reloadProjects').onclick = loadProjects;
document.getElementById('openProjectForm').onclick = ()=> { document.getElementById('projectEditorCard').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); };
document.getElementById('closeProjectEditor').onclick = ()=> document.getElementById('projectEditorCard').style.display='none';

async function loadProjects(){
  try{
    const res = await fetch(API.project);
    const list = res.ok ? await res.json() : [];
    const q = (document.getElementById('projSearch').value || '').toLowerCase();
    const ft = document.getElementById('projFilter').value;
    const grid = document.getElementById('projectsGrid'); grid.innerHTML='';

    (list||[]).filter(p=>{
      if(ft !== 'all' && ((p.ProjectType||'web').toLowerCase() !== ft)) return false;
      if(!q) return true;
      const inName = (p.Name||'').toLowerCase().includes(q);
      const inTech = Array.isArray(p.UsedTechnology) && p.UsedTechnology.some(t => (t||'').toLowerCase().includes(q));
      return inName || inTech;
    }).forEach(p=>{
      const col = document.createElement('div'); col.className='col-md-6 col-lg-4';
      const img = urlFor(p.Image) || 'https://via.placeholder.com/600x400?text=No+Image';
      col.innerHTML = `
        <div class="card h-100">
          <img src="${img}" class="img-thumb" alt="">
          <div class="p-3">
            <div class="d-flex justify-content-between">
              <h6 class="fw-bold mb-1">${p.Name||''}</h6>
              <span class="badge badge-soft">${p.ProjectType||'web'}</span>
            </div>
            <div class="small muted mb-2">${p.Description||''}</div>
            <div class="mb-2">${(p.UsedTechnology||[]).map(t=>`<span class="badge text-bg-secondary me-1">${t}</span>`).join('')}</div>
            <div class="d-flex justify-content-between">
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-info" target="_blank" href="${p.ProjectLink||'#'}">فتح</a>
                <a class="btn btn-sm btn-outline-secondary" target="_blank" href="${urlFor(p.Image)}">صورة</a>
              </div>
              <div>
                <button class="btn btn-sm btn-warning me-1 btn-edit-project" data-id="${p.id}"><i class="fa-solid fa-pen"></i></button>
                <button class="btn btn-sm btn-danger btn-del-project" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          </div>
        </div>`;
      grid.appendChild(col);
    });

  }catch(err){ console.error(err); pushToast('تعذر جلب المشاريع', 'error'); }
}

/* Edit project: since backend doesn't have GET /api/Project/:id, we GET all and find by id */
document.getElementById('projectsGrid').addEventListener('click', async (e)=>{
  const editBtn = e.target.closest('.btn-edit-project');
  const delBtn = e.target.closest('.btn-del-project');
  if(editBtn){
    const id = editBtn.dataset.id;
    try{
      // fetch all projects then find
      const res = await fetch(API.project);
      if(!res.ok) return pushToast('تعذر الوصول للمشاريع', 'error');
      const projects = await res.json();
      const p = projects.find(x => String(x.id) === String(id));
      if(!p) { pushToast('لم يتم العثور على المشروع', 'error'); return; }
      // fill form
      document.getElementById('p_id').value = p.id;
      document.getElementById('p_name').value = p.Name || '';
      document.getElementById('p_link').value = p.ProjectLink || '';
      document.getElementById('p_desc').value = p.Description || '';
      document.getElementById('p_type').value = p.ProjectType || 'web';
      projTags = Array.isArray(p.UsedTechnology) ? [...p.UsedTechnology] : [];
      renderProjTags();
      document.getElementById('projectEditorCard').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }catch(err){ console.error(err); pushToast('خطأ أثناء التحضير للتعديل', 'error'); }
  }
  if(delBtn){
    const id = delBtn.dataset.id;
    if(!confirm('تأكيد حذف المشروع؟')) return;
    try{
      const res = await fetch(API.project + '/' + id, { method: 'DELETE' });
      if(res.ok){ pushToast('تم الحذف', 'success'); loadProjects(); loadStats(); } else pushToast('فشل الحذف', 'error');
    }catch(err){ console.error(err); pushToast('خطأ أثناء الحذف', 'error'); }
  }
});

/* Save project (POST or PUT) — FormData to allow image upload */
document.getElementById('projectForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const saveBtn = document.getElementById('p_saveBtn');
  saveBtn.disabled = true;
  const id = document.getElementById('p_id').value;
  const fd = new FormData();
  fd.append('Name', document.getElementById('p_name').value);
  fd.append('Description', document.getElementById('p_desc').value);
  fd.append('ProjectLink', document.getElementById('p_link').value || '');
  fd.append('ProjectType', document.getElementById('p_type').value || 'web');
  fd.append('UsedTechnology', JSON.stringify(projTags));
  const file = document.getElementById('p_image').files[0]; if(file) fd.append('Image', file);
  const alertEl = document.getElementById('p_alert');
  try{
    // ensure API variable refreshed
    API = buildAPI();
    const url = API.project + (id ? '/' + id : '');
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, { method, body: fd });
    if(!res.ok) throw new Error('فشل الحفظ');
    showShort('تم الحفظ بنجاح', 'success');
    e.target.reset(); projTags = []; renderProjTags(); document.getElementById('p_id').value='';
    loadProjects(); loadStats();
  }catch(err){ console.error(err); showShort('خطأ أثناء الحفظ', 'error'); }
  saveBtn.disabled = false;
});

/* ======= Posts ======= */
document.getElementById('openPostForm').onclick = ()=> { document.getElementById('postEditorCard').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); };
document.getElementById('closePostEditor').onclick = ()=> document.getElementById('postEditorCard').style.display='none';
document.getElementById('reloadPosts').onclick = loadPosts;

async function loadPosts(){
  try{
    const res = await fetch(API.post);
    const list = res.ok ? await res.json() : [];
    const grid = document.getElementById('postsGrid'); grid.innerHTML='';
    (list||[]).slice().reverse().forEach(p=>{
      const col = document.createElement('div'); col.className='col-md-6 col-lg-4';
      const firstImg = (p.Photos && p.Photos[0]) ? urlFor(p.Photos[0]) : 'https://via.placeholder.com/600x400?text=No+Image';
      col.innerHTML = `
        <div class="card h-100">
          <img src="${firstImg}" class="img-thumb" alt="">
          <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <h6 class="fw-bold mb-0">#${p.id}</h6>
              <div>
                <button class="btn btn-sm btn-warning me-1 btn-edit-post" data-id="${p.id}"><i class="fa-solid fa-pen"></i></button>
                <button class="btn btn-sm btn-danger btn-del-post" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
            <div class="small mb-2">${p.Text||''}</div>
            <div class="d-flex flex-wrap gap-1">
              ${(p.Photos||[]).map(ph=>`<a target="_blank" href="${urlFor(ph)}" class="badge text-bg-secondary">صورة</a>`).join('')}
            </div>
          </div>
        </div>`;
      grid.appendChild(col);
    });
  }catch(err){ console.error(err); pushToast('تعذر جلب المنشورات', 'error'); }
}

document.getElementById('postForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  fd.append('Text', document.getElementById('post_text').value);
  const files = document.getElementById('post_photos').files;
  for(const f of files) fd.append('Photos', f);
  try{
    const res = await fetch(API.post, { method:'POST', body: fd });
    if(!res.ok) throw new Error('فشل الرفع');
    pushToast('تم نشر المنشور', 'success'); e.target.reset(); loadPosts(); loadStats();
  }catch(err){ console.error(err); pushToast('تعذر النشر', 'error'); }
});

document.getElementById('postsGrid').addEventListener('click', async (e)=>{
  const edit = e.target.closest('.btn-edit-post');
  const del = e.target.closest('.btn-del-post');
  if(edit){
    const id = edit.dataset.id;
    const newText = prompt('تعديل نص المنشور:');
    if(newText === null) return;
    try{
      const res = await fetch(API.post + '/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ Text:newText }) });
      if(res.ok){ pushToast('تم التعديل', 'success'); loadPosts(); } else pushToast('فشل التعديل', 'error');
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
  if(del){
    const id = del.dataset.id;
    if(!confirm('حذف المنشور؟')) return;
    try{
      const res = await fetch(API.post + '/' + id, { method:'DELETE' });
      if(res.ok){ pushToast('تم الحذف', 'success'); loadPosts(); loadStats(); } else pushToast('فشل الحذف', 'error');
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
});

/* ======= Appointments ======= */
document.getElementById('reloadAppointments').onclick = loadAppointments;

async function loadAppointments(){
  try{
    const res = await fetch(API.appointment);
    const arr = res.ok ? await res.json() : [];
    const tb = document.getElementById('appointmentsTable'); tb.innerHTML='';
    (arr||[]).slice().reverse().forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.id||''}</td><td>${a.FullName||''}</td><td>${a.Email||''}</td><td>${a.Phone||''}</td><td>${a.Date||''}</td><td>${a.Time||''}</td><td>${a.file?`<a href="${urlFor(a.file)}" target="_blank">📎</a>`:''}</td>`;
      tb.appendChild(tr);
    });
  }catch(err){ console.error(err); pushToast('تعذر جلب المواعيد', 'error'); }
}

document.getElementById('appointmentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  try{
    const res = await fetch(API.appointment, { method:'POST', body: fd });
    if(!res.ok) throw new Error('فشل الحفظ');
    pushToast('تم الحفظ', 'success'); e.target.reset(); loadAppointments(); loadStats();
  }catch(err){ console.error(err); pushToast('تعذر الحفظ', 'error'); }
});

/* ======= Technologies ======= */
document.getElementById('reloadTech').onclick = loadTech;
document.getElementById('closeTechEditor').onclick = ()=> document.getElementById('techEditorCard').style.display='none';
document.getElementById('t_reset').onclick = ()=>{ document.getElementById('techForm').reset(); document.getElementById('t_id').value=''; };

async function loadTech(){
  try{
    const res = await fetch(API.tech); const list = res.ok ? await res.json() : [];
    const grid = document.getElementById('techGrid'); grid.innerHTML='';
    (list||[]).forEach(t=>{
      const col = document.createElement('div'); col.className='col-md-6 col-lg-4';
      const img = urlFor(t.Image) || 'https://via.placeholder.com/400x220?text=No+Image';
      col.innerHTML = `
        <div class="card h-100 p-3 d-flex">
          <div class="d-flex align-items-center gap-3 mb-2">
            <img src="${img}" style="width:60px;height:60px;border-radius:12px;object-fit:cover">
            <div class="flex-grow-1">
              <h6 class="mb-0">${t.TechnologyName||''}</h6>
              <div class="small muted">#${t.id}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-warning me-1 btn-edit-tech" data-id="${t.id}"><i class="fa-solid fa-pen"></i></button>
              <button class="btn btn-sm btn-danger btn-del-tech" data-id="${t.id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>`;
      grid.appendChild(col);
    });
  }catch(err){ console.error(err); pushToast('تعذر جلب التقنيات', 'error'); }
}

document.getElementById('techGrid').addEventListener('click', async (e)=>{
  const ed = e.target.closest('.btn-edit-tech');
  const del = e.target.closest('.btn-del-tech');
  if(ed){
    const id = ed.dataset.id;
    try{
      const res = await fetch(API.tech + '/' + id);
      if(!res.ok) return pushToast('لم يتم العثور على التقنية', 'error');
      const t = await res.json();
      document.getElementById('t_id').value = t.id;
      document.getElementById('t_name').value = t.TechnologyName || '';
      document.getElementById('techEditorCard').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
  if(del){
    const id = del.dataset.id;
    if(!confirm('حذف التقنية؟')) return;
    try{
      const res = await fetch(API.tech + '/' + id, { method: 'DELETE' });
      if(res.ok) { pushToast('تم الحذف', 'success'); loadTech(); } else pushToast('فشل الحذف', 'error');
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
});

document.getElementById('techForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('t_id').value;
  const fd = new FormData();
  fd.append('TechnologyName', document.getElementById('t_name').value);
  const file = document.getElementById('t_image').files[0]; if(file) fd.append('Image', file);
  try{
    const res = await fetch(API.tech + (id ? '/' + id : ''), { method: id ? 'PUT' : 'POST', body: fd });
    if(!res.ok) throw new Error('فشل الحفظ');
    pushToast('تم الحفظ', 'success'); e.target.reset(); document.getElementById('t_id').value=''; loadTech();
  }catch(err){ console.error(err); pushToast('تعذر الحفظ', 'error'); }
});

/* ======= Testimonials ======= */
document.getElementById('reloadTestimonials').onclick = loadTestimonials;
document.getElementById('openTestimonialForm').onclick = ()=> { document.getElementById('testimonialEditorCard').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); };
document.getElementById('closeTestimonialEditor').onclick = ()=> document.getElementById('testimonialEditorCard').style.display='none';
document.getElementById('tt_reset').onclick = ()=> { document.getElementById('testimonialForm').reset(); document.getElementById('tt_id').value=''; };

async function loadTestimonials(){
  try{
    const res = await fetch(API.testimonial);
    const list = res.ok ? await res.json() : [];
    const grid = document.getElementById('testimonialGrid'); grid.innerHTML='';
    (list||[]).forEach(t=>{
      const col = document.createElement('div'); col.className='col-md-6 col-lg-4';
      const img = urlFor(t.Image) || 'https://via.placeholder.com/400x220?text=No+Image';
      col.innerHTML = `
        <div class="card h-100 p-3">
          <div class="d-flex gap-3 mb-2 align-items-center">
            <img src="${img}" style="width:60px;height:60px;border-radius:12px;object-fit:cover">
            <div class="flex-grow-1">
              <h6 class="mb-0">${t.Name||''}</h6>
              <div class="small muted">${t.JobOrCompany||''}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-warning me-1 btn-edit-test" data-id="${t.id}"><i class="fa-solid fa-pen"></i></button>
              <button class="btn btn-sm btn-danger btn-del-test" data-id="${t.id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <p class="small">${t.Opinion||''}</p>
        </div>`;
      grid.appendChild(col);
    });
  }catch(err){ console.error(err); pushToast('تعذر جلب الآراء', 'error'); }
}

document.getElementById('testimonialGrid').addEventListener('click', async (e)=>{
  const ed = e.target.closest('.btn-edit-test');
  const del = e.target.closest('.btn-del-test');
  if(ed){
    const id = ed.dataset.id;
    try{
      const res = await fetch(API.testimonial + '/' + id);
      if(!res.ok) return pushToast('لم يتم العثور على الرأي', 'error');
      const t = await res.json();
      document.getElementById('tt_id').value = t.id;
      document.getElementById('tt_name').value = t.Name || '';
      document.getElementById('tt_job').value = t.JobOrCompany || '';
      document.getElementById('tt_opinion').value = t.Opinion || '';
      document.getElementById('testimonialEditorCard').style.display = 'block';
      window.scrollTo({ top: 0, behavior:'smooth' });
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
  if(del){
    const id = del.dataset.id;
    if(!confirm('حذف؟')) return;
    try{
      const res = await fetch(API.testimonial + '/' + id, { method: 'DELETE' });
      if(res.ok) { pushToast('تم الحذف', 'success'); loadTestimonials(); } else pushToast('فشل الحذف', 'error');
    }catch(err){ console.error(err); pushToast('خطأ', 'error'); }
  }
});

document.getElementById('testimonialForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('tt_id').value;
  const fd = new FormData();
  fd.append('Name', document.getElementById('tt_name').value);
  fd.append('JobOrCompany', document.getElementById('tt_job').value || '');
  fd.append('Opinion', document.getElementById('tt_opinion').value);
  const file = document.getElementById('tt_image').files[0]; if(file) fd.append('Image', file);
  try{
    const res = await fetch(API.testimonial + (id ? '/' + id : ''), { method: id ? 'PUT' : 'POST', body: fd });
    if(!res.ok) throw new Error('فشل حفظ');
    pushToast('تم الحفظ', 'success'); e.target.reset(); document.getElementById('tt_id').value=''; loadTestimonials();
  }catch(err){ console.error(err); pushToast('تعذر الحفظ', 'error'); }
});

/* ======= Login (simple) ======= */
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = new FormData(e.target);
  const payload = { username: f.get('username'), password: f.get('password') };
  try{
    const res = await fetch(API.login, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('Invalid');
    const data = await res.json();
    const username = data.username || data.user || 'user';
    localStorage.setItem('whoami', username);
    document.getElementById('whoami').textContent = username;
    document.getElementById('btnLogin').style.display='none';
    document.getElementById('btnLogout').style.display='inline-block';
    pushToast('تم تسجيل الدخول', 'success');
  }catch(err){ pushToast('بيانات غير صحيحة', 'error'); }
});
document.getElementById('btnLogin').onclick = ()=> { navLinks.forEach(l=>l.classList.remove('active')); document.querySelector('[data-target="users"]').classList.add('active'); Object.values(views).forEach(v=>v.classList.add('d-none')); views.users.classList.remove('d-none'); };
document.getElementById('btnLogout').onclick = ()=> { localStorage.removeItem('whoami'); document.getElementById('whoami').textContent='زائر'; document.getElementById('btnLogin').style.display='inline-block'; document.getElementById('btnLogout').style.display='none'; };

/* ======= Settings & partners ======= */
const setForm = document.getElementById('settingsForm');
document.getElementById('set_api').value = API_BASE;
document.getElementById('set_logoText').value = defaults.logoText;
document.getElementById('set_theme').value = defaults.theme;

setForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  API_BASE = document.getElementById('set_api').value.trim() || API_BASE;
  localStorage.setItem('API_BASE', API_BASE);
  localStorage.setItem('logoText', document.getElementById('set_logoText').value.trim()||'A');
  localStorage.setItem('theme', document.getElementById('set_theme').value);
  pushToast('تم حفظ الإعدادات — سيتم إعادة تحميل الصفحة', 'info', 1500);
  setTimeout(()=> location.reload(), 900);
});
document.getElementById('settingsReset').onclick = ()=>{
  localStorage.removeItem('API_BASE'); localStorage.removeItem('logoText'); localStorage.removeItem('theme'); localStorage.removeItem('partners'); location.reload();
};

function renderPartners(){
  const box = document.getElementById('partner_list'); box.innerHTML='';
  const side = document.getElementById('partners'); side.innerHTML='';
  const arr = JSON.parse(localStorage.getItem('partners')||'[]');
  arr.forEach((src,i)=>{
    const chip = document.createElement('div'); chip.className='d-flex align-items-center gap-2 badge text-bg-secondary';
    chip.innerHTML = `<img src="${src}" style="width:34px;height:18px;object-fit:cover;border-radius:4px"><span>شريك ${i+1}</span><button class="btn-close btn-close-white btn-sm ms-1" data-i="${i}"></button>`;
    chip.querySelector('button').onclick = ()=>{ arr.splice(i,1); localStorage.setItem('partners',JSON.stringify(arr)); renderPartners(); }
    box.appendChild(chip);
    const img = document.createElement('img'); img.src=src; img.className='rounded'; img.style.width='60px'; img.style.height='28px'; img.style.objectFit='cover';
    side.appendChild(img);
  });
}
document.getElementById('partner_add_btn').onclick = ()=>{
  const v = document.getElementById('partner_add').value.trim(); if(!v){ pushToast('أدخل رابط صورة الشريك', 'error'); return; }
  const arr = JSON.parse(localStorage.getItem('partners')||'[]'); arr.push(v); localStorage.setItem('partners', JSON.stringify(arr)); document.getElementById('partner_add').value=''; renderPartners(); pushToast('تمت الإضافة', 'success');
};
renderPartners();

/* ======= Boot ======= */
function boot(){
  const me = localStorage.getItem('whoami');
  if(me){ document.getElementById('whoami').textContent = me; document.getElementById('btnLogin').style.display='none'; document.getElementById('btnLogout').style.display='inline-block'; }
  loadStats(); loadProjects(); loadPosts(); loadAppointments(); loadTech(); loadTestimonials();
}
boot();

/* ======= small helper for inline messages ======= */
function showShort(msg, type='success'){ pushToast(msg, type); }

 // live search/filter
document.getElementById('projSearch').addEventListener('input', loadProjects);
document.getElementById('projFilter').addEventListener('change', loadProjects);

</script>
</body>
</html>
